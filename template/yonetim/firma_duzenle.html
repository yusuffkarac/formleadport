{% extends 'base.html' %}
{% load static %}

{% block title %}Firma bearbeiten | Einstellungen{% endblock %}
{% block description %}Bearbeiten Sie Ihre Firmendaten (Name, Logo, Icon, Telefonnummer, Adresse) und SMTP-Einstellungen (Server, Port, Benutzername, Passwort, TLS/SSL) an einem Ort.{% endblock %}
{% block head %}
<style>
  .bg-secondary-subtle { background: var(--bs-secondary-bg-subtle, #f1f1f4); }
</style>
<style>
   #email_onay_editor{
     height: 30rem;
   }
   #termin_onay_editor{
     height: 30rem;
   }
  /* CKEditor içeriği kartla uyumlu gözüksün */
  .ck-editor-wrap .ck-content {
    min-height: 160px;
    border: 0 !important;
    background: transparent;
    font-size: 1rem;
    line-height: 1.5;
  }
  .ck.ck-editor__editable:not(.ck-editor__nested-editable) {
    padding: 0.5rem 0.75rem;
  }

  /* Sigorta listesi – mobil iyileştirmeler */
  #sigorta_liste .sigorta-item .item-wrap {
    display: flex;
    align-items: center;
    gap: 12px;
    border: 1px solid var(--bs-border-color, #e5e7eb);
    border-radius: .5rem;
    padding: 12px;
    background: #f8f9fa;
    min-width: 0; /* overflow engeli */
  }

  #sigorta_liste .symbol {
    width: 48px;
    height: 48px;
  }

  #sigorta_liste .js-preview,
  #sigorta_liste .js-preview-empty {
    width: 100%;
    height: 100%;
    object-fit: contain;
    border-radius: .375rem;
    background: #fff;
    padding: 2px;
  }

  /* İsim input’u satırın gerilimini alsın */
  #sigorta_liste .name-col {
    flex: 1 1 auto;
    min-width: 0;
  }

  /* Aksiyon butonları ve dosya alanı birlikte davransın */
  #sigorta_liste .ctrl-col {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap; /* dar alanda alta geçsin */
  }

  /* Küçük ekran: blok blok yerleşim */
  @media (max-width: 576px) {
    #sigorta_liste .sigorta-item .item-wrap {
      flex-direction: column;
      align-items: stretch;
      gap: 10px;
      padding: 12px;
    }

    #sigorta_liste .symbol {
      width: 56px;
      height: 56px;
      align-self: flex-start;
    }

    #sigorta_liste .name-col input {
      /* mobilde dokunmatik rahatlığı */
      height: 42px;
    }

    #sigorta_liste .file-block {
      width: 100%;
    }

    #sigorta_liste .file-block .form-control {
      width: 100%;
    }

    #sigorta_liste .actions {
      display: flex;
      gap: 8px;
      width: 100%;
      justify-content: space-between; /* oklar solda/ortada, sil sağda gibi */
      flex-wrap: wrap;
    }

    /* Butonlar kolay tıklansın */
    #sigorta_liste .actions .btn {
      flex: 1 1 32%;
    }

    /* Checkbox etiketi satıra sığsın */
    #sigorta_liste .del-check {
      margin-top: 0 !important;
    }
  }

  /* Orta ekranlarda da daha esnek davranış */
  @media (min-width: 577px) and (max-width: 992px) {
    #sigorta_liste .ctrl-col {
      flex: 0 0 auto;
    }
  }

</style>
{% endblock %}
{% block content %}
<!--begin::Toolbar-->
<div class="toolbar py-5 py-lg-15" id="kt_toolbar">
  <div id="kt_toolbar_container" class="container-xxl d-flex flex-stack flex-wrap">
    <h3 class="text-white fw-bolder fs-2qx me-5">Firma bearbeiten</h3>
  </div>
</div>
<!--end::Toolbar-->

<div id="kt_content_container" class="flex-column-fluid align-items-start container-xxl">
  <div class="content flex-row-fluid" id="kt_content">
    <div class="d-flex flex-column flex-xl-row">
      <div class="flex-lg-row-fluid">
        {% include 'widgets/messages.html' %}
        <!--begin::Firmendaten-->
        <div class="card mb-5 mb-xl-10">
          <div class="card-header border-0 cursor-pointer" role="button"
               data-bs-toggle="collapse" data-bs-target="#kt_company_details"
               aria-expanded="true" aria-controls="kt_company_details">
            <div class="card-title m-0">
              <h3 class="fw-bold m-0">Firmendaten</h3>
            </div>
          </div>

          <div id="kt_company_details" class="collapse show">
            <form class="form fv-plugins-bootstrap5 fv-plugins-framework"
                  method="post" enctype="multipart/form-data" novalidate>
              {% csrf_token %}
              <input type="hidden" name="form_type" value="firma">
              <div class="card-body border-top p-9">

                <!-- Firmenname -->
                <div class="row mb-6">
                  <label class="col-lg-4 col-form-label required fw-semibold fs-6">Firmenname</label>
                  <div class="col-lg-8 fv-row fv-plugins-icon-container">
                    {{ firma_form.isim }}
                    {% if firma_form.isim.errors %}
                      <div class="fv-plugins-message-container fv-plugins-message-container--enabled invalid-feedback d-block">
                        {{ firma_form.isim.errors|striptags }}
                      </div>
                    {% endif %}
                  </div>
                </div>

                <!-- Firmen-Slogan -->
                <div class="row mb-6">
                  <label class="col-lg-4 col-form-label fw-semibold fs-6">Slogan</label>
                  <div class="col-lg-8 fv-row fv-plugins-icon-container">
                    {{ firma_form.slogan }}
                    {% if firma_form.slogan.errors %}
                      <div class="fv-plugins-message-container fv-plugins-message-container--enabled invalid-feedback d-block">
                        {{ firma_form.slogan.errors|striptags }}
                      </div>
                    {% endif %}
                    <div class="form-text">Kurze Unternehmensbotschaft oder Motto (optional).</div>
                  </div>
                </div>


                {# --- LOGO --- #}
                <div class="row mb-6">
                    <label class="col-lg-4 col-form-label fw-semibold fs-6">Logo</label>
                    <div class="col-lg-8">
                        <div class="d-flex align-items-center gap-5">
                            <!-- Önizleme kutusu -->
                            <div class="rounded border bg-light d-flex align-items-center justify-content-center shadow-sm p-3" style="width: 140px; height: 100px; overflow: hidden;">
                                {% if firma and firma.logo %}
                                <img id="logoPreview" src="{{ firma.logo.url }}" alt="Logo" class="img-fluid" style="max-height: 100px;">
                                {% else %}
                                <img id="logoPreview" src="{% static 'media/placeholders/logo-placeholder.png' %}" alt="Logo" class="img-fluid opacity-50" style="max-height: 100px;">
                                {% endif %}
                            </div>

                            <div class="d-flex flex-column">
                                {{ firma_form.logo }}
                                <label for="id_logo" class="btn btn-light btn-active-light-primary w-auto">
                                Logo ändern
                                </label>
                                <small class="text-muted mt-2">
                                Erlaubte Formate: PNG, JPG, JPEG. Empfohlen: quadratisch (512×512 px).
                                </small>

                                {% if firma_form.logo.errors %}
                                <div class="fv-plugins-message-container fv-plugins-message-container--enabled invalid-feedback d-block mt-2">
                                    {{ firma_form.logo.errors|striptags }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                {# --- ICON --- #}
                <div class="row mb-6">
                    <label class="col-lg-4 col-form-label fw-semibold fs-6">Icon</label>
                    <div class="col-lg-8">
                        <div class="d-flex align-items-center gap-5">
                            <!-- Önizleme kutusu (daha küçük) -->
                            <div class="rounded border bg-light d-flex align-items-center justify-content-center shadow-sm p-3" style="width: 100px; height: 70px; overflow: hidden;">
                                {% if firma and firma.icon %}
                                <!-- <img id="iconPreview" src="{{ firma.icon.url }}" alt="Icon" class="img-fluid" style="max-height: 70px;"> -->
                                {% else %}
                                <img id="iconPreview" src="{% static 'media/placeholders/icon-placeholder.png' %}" alt="Icon" class="img-fluid opacity-50" style="max-height: 70px;">
                                {% endif %}
                            </div>

                            <div class="d-flex flex-column">
                                <!-- Gizli gerçek input -->
                                {{ firma_form.icon }}

                                <!-- Tetikleyici buton -->
                                <label for="id_icon" class="btn btn-light btn-active-light-primary w-auto">
                                Icon ändern
                                </label>
                                <small class="text-muted mt-2">
                                Erlaubte Formate: PNG, JPG, JPEG. Transparenter Hintergrund empfohlen (PNG).
                                </small>

                                {% if firma_form.icon.errors %}
                                <div class="fv-plugins-message-container fv-plugins-message-container--enabled invalid-feedback d-block mt-2">
                                    {{ firma_form.icon.errors|striptags }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Telefonnummer -->
                <div class="row mb-6">
                  <label class="col-lg-4 col-form-label fw-semibold fs-6">Telefonnummer</label>
                  <div class="col-lg-8 fv-row fv-plugins-icon-container">
                    {{ firma_form.telefon }}
                    {% if firma_form.telefon.errors %}
                      <div class="fv-plugins-message-container fv-plugins-message-container--enabled invalid-feedback d-block">
                        {{ firma_form.telefon.errors|striptags }}
                      </div>
                    {% endif %}
                  </div>
                </div>

                <!-- Adresse -->
                <div class="row mb-6">
                  <label class="col-lg-4 col-form-label fw-semibold fs-6">Adresse</label>
                  <div class="col-lg-8 fv-row fv-plugins-icon-container">
                    {{ firma_form.adres }}
                    {% if firma_form.adres.errors %}
                      <div class="fv-plugins-message-container fv-plugins-message-container--enabled invalid-feedback d-block">
                        {{ firma_form.adres.errors|striptags }}
                      </div>
                    {% endif %}
                  </div>
                </div>

                <!-- SMS-Schreibweise -->
                <div class="row mb-0">
                  <label class="col-lg-4 col-form-label fw-semibold fs-6">SMS-Schreibweise</label>
                  <div class="col-lg-8 fv-row fv-plugins-icon-container">
                    {{ firma_form.sms_yazisi }}
                    {% if firma_form.sms_yazisi.errors %}
                      <div class="fv-plugins-message-container fv-plugins-message-container--enabled invalid-feedback d-block">
                        {{ firma_form.sms_yazisi.errors|striptags }}
                      </div>
                    {% endif %}
                  </div>
                </div>

              </div>
              <div class="card-footer d-flex justify-content-end py-6 px-9">
                <a href="{% url 'firma_duzenle' %}" class="btn btn-light btn-active-light-primary me-2">Verwerfen</a>
                <button type="submit" class="btn btn-primary">Änderungen speichern</button>
              </div>
            </form>
          </div>
        </div>
        <!--end::Firmendaten-->

        {% if request.user.is_superuser or request.user.rol == 'Admin' %}
        <!--begin::E-Mail-Benachrichtigungen-->
        <div class="card mb-5 mb-xl-10">
          <div class="card-header border-0 cursor-pointer" role="button"
              data-bs-toggle="collapse" data-bs-target="#kt_email_details"
              aria-expanded="true" aria-controls="kt_email_details">
            <div class="card-title m-0">
              <h3 class="fw-bold m-0">E-Mail-Benachrichtigungen</h3>
            </div>
          </div>

          <div id="kt_email_details" class="collapse show">
            <form id="email_form" class="form fv-plugins-bootstrap5 fv-plugins-framework" method="post" novalidate>
              {% csrf_token %}
              <input type="hidden" name="form_type" value="email">
              <div class="card-body border-top p-9">

                <!-- E-Mail-Bestätigung aktivieren -->
                <div class="row mb-6">
                  <label class="col-lg-4 col-form-label fw-semibold fs-6">E-Mail-Bestätigung</label>
                  <div class="col-lg-8 d-flex align-items-center gap-5">
                    <label class="form-check form-check-solid form-switch form-check-custom fv-row mb-0">
                      <input type="checkbox" name="email_dogrulama"
                            class="form-check-input w-45px h-30px"
                            {% if firma and firma.email_dogrulama %}checked{% endif %}>
                      <span class="form-check-label ms-3">Bestätigung aktivieren</span>
                    </label>
                  </div>
                </div>

                <!-- Bestätigungstext -->
                <div class="row mb-0">
                  <label class="col-lg-4 col-form-label fw-semibold fs-6">Bestätigungstext</label>
                  <div class="col-lg-8 fv-row fv-plugins-icon-container">
                    <!-- Variable Buttons -->
                    <div class="mb-3">
                      <span class="text-muted small me-3 d-block mb-2">Verfügbare Variablen (klicken oder per Drag & Drop einfügen):</span>
                      
                      <!-- Doğrulama Kodu -->
                      <div class="btn btn-sm btn-light-primary me-2 mb-2 email-variable" 
                           draggable="true" 
                           data-variable="{% verbatim %}{{code}}{% endverbatim %}"
                           style="cursor: pointer; user-select: none;"
                           title="Klicken oder per Drag & Drop einfügen"
                           onclick="insertEmailVariable('{% verbatim %}{{code}}{% endverbatim %}')">
                        <i class="ki-duotone ki-code fs-6 me-1">
                          <span class="path1"></span>
                          <span class="path2"></span>
                        </i>
                        Code
                      </div>
                      
                      <!-- Firma İsmi -->
                      <div class="btn btn-sm btn-light-success me-2 mb-2 email-variable" 
                           draggable="true" 
                           data-variable="{% verbatim %}{{firma_name}}{% endverbatim %}"
                           style="cursor: pointer; user-select: none;"
                           title="Klicken oder per Drag & Drop einfügen"
                           onclick="insertEmailVariable('{% verbatim %}{{firma_name}}{% endverbatim %}')">
                        <i class="ki-duotone ki-office-bag fs-6 me-1">
                          <span class="path1"></span>
                          <span class="path2"></span>
                        </i>
                        Firma
                      </div>
                      
                      <!-- Firma Logosu -->
                      <div class="btn btn-sm btn-light-info me-2 mb-2 email-variable" 
                           draggable="true" 
                           data-variable="{% verbatim %}{{firma_logo}}{% endverbatim %}"
                           style="cursor: pointer; user-select: none;"
                           title="Klicken oder per Drag & Drop einfügen"
                           onclick="insertEmailVariable('{% verbatim %}{{firma_logo}}{% endverbatim %}')">
                        <i class="ki-duotone ki-picture fs-6 me-1">
                          <span class="path1"></span>
                          <span class="path2"></span>
                        </i>
                        Logo
                      </div>
                      
                      <!-- Firma Telefonu -->
                      <div class="btn btn-sm btn-light-warning me-2 mb-2 email-variable" 
                           draggable="true" 
                           data-variable="{% verbatim %}{{firma_phone}}{% endverbatim %}"
                           style="cursor: pointer; user-select: none;"
                           title="Klicken oder per Drag & Drop einfügen"
                           onclick="insertEmailVariable('{% verbatim %}{{firma_phone}}{% endverbatim %}')">
                        <i class="ki-duotone ki-phone fs-6 me-1">
                          <span class="path1"></span>
                          <span class="path2"></span>
                        </i>
                        Telefon
                      </div>
                      
                      <!-- Firma Adresi -->
                      <div class="btn btn-sm btn-light-danger me-2 mb-2 email-variable" 
                           draggable="true" 
                           data-variable="{% verbatim %}{{firma_address}}{% endverbatim %}"
                           style="cursor: pointer; user-select: none;"
                           title="Klicken oder per Drag & Drop einfügen"
                           onclick="insertEmailVariable('{% verbatim %}{{firma_address}}{% endverbatim %}')">
                        <i class="ki-duotone ki-geolocation fs-6 me-1">
                          <span class="path1"></span>
                          <span class="path2"></span>
                        </i>
                        Adresse
                      </div>
                      
                      <!-- Müşteri İsmi -->
                      <div class="btn btn-sm btn-light-dark me-2 mb-2 email-variable d-none" 
                           draggable="true" 
                           data-variable="{% verbatim %}{{customer_name}}{% endverbatim %}"
                           style="cursor: pointer; user-select: none;"
                           title="Klicken oder per Drag & Drop einfügen"
                           onclick="insertEmailVariable('{% verbatim %}{{customer_name}}{% endverbatim %}')">
                        <i class="ki-duotone ki-profile-user fs-6 me-1">
                          <span class="path1"></span>
                          <span class="path2"></span>
                        </i>
                        Kunde
                      </div>
                      
                    </div>
                    
                    <!-- Text Formatting -->
                    <div class="mb-3">
                      <span class="text-muted small d-block mb-2">Text formatieren (Text auswählen und Button klicken):</span>
                      <div class="d-flex flex-wrap gap-2">
                        <button type="button" class="btn btn-sm btn-light-primary email-format-btn" 
                                data-format="bold" title="Macht den ausgewählten Text fett">
                          <strong>Fett</strong>
                        </button>
                        <button type="button" class="btn btn-sm btn-light-primary email-format-btn" 
                                data-format="italic" title="Macht den ausgewählten Text kursiv">
                          <em>Kursiv</em>
                        </button>
                        <button type="button" class="btn btn-sm btn-light-primary email-format-btn" 
                                data-format="underline" title="Unterstreicht den ausgewählten Text">
                          <u>Unterstrichen</u>
                        </button>
                        <button type="button" class="btn btn-sm btn-light-success email-format-btn" 
                                data-format="h1" title="Macht eine große Überschrift">
                          Große Überschrift
                        </button>
                        <button type="button" class="btn btn-sm btn-light-success email-format-btn" 
                                data-format="h2" title="Macht eine mittlere Überschrift">
                          Mittlere Überschrift
                        </button>
                        <button type="button" class="btn btn-sm btn-light-warning email-format-btn" 
                                data-format="center" title="Zentriert den Text">
                          Zentrieren
                        </button>
                        <button type="button" class="btn btn-sm btn-light-danger email-format-btn" 
                                data-format="color" title="Ändert die Textfarbe">
                          Farbe ändern
                        </button>
                      </div>
                    </div>
                    
                    <!-- Preview Button -->
                    <div class="mb-3">
                      <button type="button" id="email_preview_btn" class="btn btn-sm btn-light-info">
                        <i class="ki-duotone ki-eye fs-6 me-1">
                          <span class="path1"></span>
                          <span class="path2"></span>
                          <span class="path3"></span>
                        </i>
                        E-Mail Vorschau
                      </button>
                    </div>
                    
                    <textarea id="email_onay_editor" name="email_onay_yazisi" rows="6"
                      class="form-control form-control-lg form-control-solid"
                      placeholder="Text für Bestätigungs-E-Mail ...">{% if firma and firma.email_onay_yazisi %}{{ firma.email_onay_yazisi }}{% endif %}</textarea>
                   
                  </div>
                </div>

                <!-- Email Preview Modal -->
                <div class="modal fade" id="emailPreviewModal" tabindex="-1" aria-labelledby="emailPreviewModalLabel" aria-hidden="true">
                  <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="emailPreviewModalLabel">
                          <i class="ki-duotone ki-sms fs-2 me-2">
                            <span class="path1"></span>
                            <span class="path2"></span>
                          </i>
                          E-Mail Vorschau
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body">
                        <div class="alert alert-info d-flex align-items-center mb-4">
                          <i class="ki-duotone ki-information-5 fs-2 me-3">
                            <span class="path1"></span>
                            <span class="path2"></span>
                            <span class="path3"></span>
                          </i>
                          <div>
                            <strong>Dies ist eine Vorschau.</strong><br>
                            Bei der tatsächlichen E-Mail-Versendung werden die Variablen automatisch ausgefüllt.
                          </div>
                        </div>
                        
                        <!-- Email Preview Container -->
                        <div class="card">
                          <div class="card-header bg-light">
                            <div class="row align-items-center">
                              <div class="col">
                                <strong>Von:</strong> {% if firma and firma.email_host_user %}{{ firma.email_host_user }}{% else %}noreply@leadport.de{% endif %}
                              </div>
                            </div>
                            <div class="row mt-2">
                              <div class="col">
                                <strong>An:</strong> mustafa.mueller@example.com
                              </div>
                            </div>
                            <div class="row mt-2">
                              <div class="col">
                                <strong>Betreff:</strong> Ihr E-Mail-Bestätigungscode
                              </div>
                            </div>
                          </div>
                          <div class="card-body" id="emailPreviewContent" style="font-family: Arial, sans-serif; line-height: 1.6; background: white;">
                            <!-- Preview content will be inserted here -->
                          </div>
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Color Picker Modal -->
                <div class="modal fade" id="colorPickerModal" tabindex="-1" aria-labelledby="colorPickerModalLabel" aria-hidden="true">
                  <div class="modal-dialog modal-md">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="colorPickerModalLabel">
                          <i class="ki-duotone ki-color-swatch fs-2 me-2">
                            <span class="path1"></span>
                            <span class="path2"></span>
                          </i>
                          Farbe wählen
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body">
                        <div class="mb-3">
                          <label class="form-label">Ausgewählter Text: <strong id="selectedTextPreview"></strong></label>
                        </div>
                        
                        <!-- Color Palette -->
                        <div class="mb-4">
                          <label class="form-label mb-3">Vordefinierte Farben:</label>
                          <div class="d-flex flex-wrap gap-2" id="colorPalette">
                            <div class="color-option" data-color="#000000" style="background: #000000;" title="Schwarz"></div>
                            <div class="color-option" data-color="#dc3545" style="background: #dc3545;" title="Rot"></div>
                            <div class="color-option" data-color="#198754" style="background: #198754;" title="Grün"></div>
                            <div class="color-option" data-color="#0d6efd" style="background: #0d6efd;" title="Blau"></div>
                            <div class="color-option" data-color="#fd7e14" style="background: #fd7e14;" title="Orange"></div>
                            <div class="color-option" data-color="#6f42c1" style="background: #6f42c1;" title="Lila"></div>
                            <div class="color-option" data-color="#d63384" style="background: #d63384;" title="Rosa"></div>
                            <div class="color-option" data-color="#20c997" style="background: #20c997;" title="Türkis"></div>
                            <div class="color-option" data-color="#ffc107" style="background: #ffc107;" title="Gelb"></div>
                            <div class="color-option" data-color="#6c757d" style="background: #6c757d;" title="Grau"></div>
                            <div class="color-option" data-color="#e74c3c" style="background: #e74c3c;" title="Hellrot"></div>
                            <div class="color-option" data-color="#3498db" style="background: #3498db;" title="Hellblau"></div>
                            <div class="color-option" data-color="#2ecc71" style="background: #2ecc71;" title="Hellgrün"></div>
                            <div class="color-option" data-color="#f39c12" style="background: #f39c12;" title="Gold"></div>
                            <div class="color-option" data-color="#9b59b6" style="background: #9b59b6;" title="Helllila"></div>
                          </div>
                        </div>
                        
                        <!-- Custom Color Input -->
                        <div class="mb-3">
                          <label class="form-label">Oder benutzerdefinierte Farbe:</label>
                          <div class="d-flex gap-2 align-items-center">
                            <input type="color" id="customColorInput" class="form-control form-control-color" value="#0d6efd" style="width: 60px;">
                            <input type="text" id="customColorText" class="form-control" placeholder="#0d6efd" value="#0d6efd">
                          </div>
                        </div>
                        
                        <!-- Preview -->
                        <div class="alert alert-light">
                          <strong>Vorschau:</strong> 
                          <span id="colorPreview" style="color: #0d6efd;">Der ausgewählte Text wird in dieser Farbe angezeigt</span>
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                        <button type="button" id="applyColorBtn" class="btn btn-primary">Farbe anwenden</button>
                      </div>
                    </div>
                  </div>
                </div>

                <style>
                  .color-option {
                    width: 40px;
                    height: 40px;
                    border-radius: 8px;
                    cursor: pointer;
                    border: 3px solid transparent;
                    transition: all 0.2s;
                    position: relative;
                  }
                  .color-option:hover {
                    transform: scale(1.1);
                    border-color: #dee2e6;
                  }
                  .color-option.selected {
                    border-color: #0d6efd;
                    transform: scale(1.1);
                  }
                  .color-option.selected::after {
                    content: '✓';
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    color: white;
                    font-weight: bold;
                    text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
                  }
                </style>

              </div>
              <div class="card-footer d-flex justify-content-end py-6 px-9">
                <a href="{% url 'firma_duzenle' %}" class="btn btn-light btn-active-light-primary me-2">Verwerfen</a>
                <button type="submit" class="btn btn-primary">Änderungen speichern</button>
              </div>
            </form>
          </div>
        </div>
        <!--end::E-Mail-Benachrichtigungen-->
        
        <!--begin::Termin-Bestätigung-->
        <div class="card mb-5 mb-xl-10">
          <div class="card-header border-0 cursor-pointer" role="button"
              data-bs-toggle="collapse" data-bs-target="#kt_termin_details"
              aria-expanded="true" aria-controls="kt_termin_details">
            <div class="card-title m-0">
              <h3 class="fw-bold m-0">Termin Bestätigung</h3>
            </div>
          </div>

          <div id="kt_termin_details" class="collapse show">
            <form id="termin_form" class="form fv-plugins-bootstrap5 fv-plugins-framework" method="post" novalidate>
              {% csrf_token %}
              <input type="hidden" name="form_type" value="termin">
              <div class="card-body border-top p-9">

                <div class="row mb-0">
                  <label class="col-lg-4 col-form-label fw-semibold fs-6">Termin Bestätigungstext</label>
                  <div class="col-lg-8 fv-row fv-plugins-icon-container">
                    <!-- Termin Variable Buttons -->
                    <div class="mb-3">
                      <span class="text-muted small me-3 d-block mb-2">Verfügbare Variablen (klicken oder per Drag & Drop einfügen):</span>
                      
                      <!-- Kunde Name -->
                      <div class="btn btn-sm btn-light-success me-2 mb-2 termin-variable" 
                           draggable="true" 
                           data-variable="{% verbatim %}{{kunde_name}}{% endverbatim %}"
                           style="cursor: pointer; user-select: none;"
                           title="Klicken oder per Drag & Drop einfügen"
                           onclick="insertTerminVariable('{% verbatim %}{{kunde_name}}{% endverbatim %}')">
                        <i class="ki-duotone ki-profile-user fs-6 me-1">
                          <span class="path1"></span>
                          <span class="path2"></span>
                        </i>
                        Kunde Name
                      </div>
                      
                      <!-- Datum -->
                      <div class="btn btn-sm btn-light-primary me-2 mb-2 termin-variable" 
                           draggable="true" 
                           data-variable="{% verbatim %}{{termin_datum}}{% endverbatim %}"
                           style="cursor: pointer; user-select: none;"
                           title="Klicken oder per Drag & Drop einfügen"
                           onclick="insertTerminVariable('{% verbatim %}{{termin_datum}}{% endverbatim %}')">
                        <i class="ki-duotone ki-calendar fs-6 me-1">
                          <span class="path1"></span>
                          <span class="path2"></span>
                        </i>
                        Datum
                      </div>
                      
                      <!-- Uhrzeit -->
                      <div class="btn btn-sm btn-light-info me-2 mb-2 termin-variable" 
                           draggable="true" 
                           data-variable="{% verbatim %}{{termin_uhrzeit}}{% endverbatim %}"
                           style="cursor: pointer; user-select: none;"
                           title="Klicken oder per Drag & Drop einfügen"
                           onclick="insertTerminVariable('{% verbatim %}{{termin_uhrzeit}}{% endverbatim %}')">
                        <i class="ki-duotone ki-time fs-6 me-1">
                          <span class="path1"></span>
                          <span class="path2"></span>
                        </i>
                        Uhrzeit
                      </div>
                      
                      <!-- Terminart -->
                      <div class="btn btn-sm btn-light-warning me-2 mb-2 termin-variable" 
                           draggable="true" 
                           data-variable="{% verbatim %}{{terminart}}{% endverbatim %}"
                           style="cursor: pointer; user-select: none;"
                           title="Klicken oder per Drag & Drop einfügen"
                           onclick="insertTerminVariable('{% verbatim %}{{terminart}}{% endverbatim %}')">
                        <i class="ki-duotone ki-devices fs-6 me-1">
                          <span class="path1"></span>
                          <span class="path2"></span>
                          <span class="path3"></span>
                          <span class="path4"></span>
                          <span class="path5"></span>
                        </i>
                        Terminart
                      </div>
                      
                      <!-- Berater Name -->
                      <div class="btn btn-sm btn-light-danger me-2 mb-2 termin-variable" 
                           draggable="true" 
                           data-variable="{% verbatim %}{{berater_name}}{% endverbatim %}"
                           style="cursor: pointer; user-select: none;"
                           title="Klicken oder per Drag & Drop einfügen"
                           onclick="insertTerminVariable('{% verbatim %}{{berater_name}}{% endverbatim %}')">
                        <i class="ki-duotone ki-user-tick fs-6 me-1">
                          <span class="path1"></span>
                          <span class="path2"></span>
                          <span class="path3"></span>
                        </i>
                        Berater
                      </div>
                      
                      <!-- Berater Position -->
                      <div class="btn btn-sm btn-light-dark me-2 mb-2 termin-variable" 
                           draggable="true" 
                           data-variable="{% verbatim %}{{berater_position}}{% endverbatim %}"
                           style="cursor: pointer; user-select: none;"
                           title="Klicken oder per Drag & Drop einfügen"
                           onclick="insertTerminVariable('{% verbatim %}{{berater_position}}{% endverbatim %}')">
                        <i class="ki-duotone ki-briefcase fs-6 me-1">
                          <span class="path1"></span>
                          <span class="path2"></span>
                        </i>
                        Position
                      </div>
                      
                      <!-- Firma Name -->
                      <div class="btn btn-sm btn-light-success me-2 mb-2 termin-variable" 
                           draggable="true" 
                           data-variable="{% verbatim %}{{firma_name}}{% endverbatim %}"
                           style="cursor: pointer; user-select: none;"
                           title="Klicken oder per Drag & Drop einfügen"
                           onclick="insertTerminVariable('{% verbatim %}{{firma_name}}{% endverbatim %}')">
                        <i class="ki-duotone ki-office-bag fs-6 me-1">
                          <span class="path1"></span>
                          <span class="path2"></span>
                        </i>
                        Firma
                      </div>
                      
                      <!-- Firma Telefon -->
                      <div class="btn btn-sm btn-light-warning me-2 mb-2 termin-variable" 
                           draggable="true" 
                           data-variable="{% verbatim %}{{firma_phone}}{% endverbatim %}"
                           style="cursor: pointer; user-select: none;"
                           title="Klicken oder per Drag & Drop einfügen"
                           onclick="insertTerminVariable('{% verbatim %}{{firma_phone}}{% endverbatim %}')">
                        <i class="ki-duotone ki-phone fs-6 me-1">
                          <span class="path1"></span>
                          <span class="path2"></span>
                        </i>
                        Telefon
                      </div>
                      
                      <!-- Firma Logo -->
                      <div class="btn btn-sm btn-light-info me-2 mb-2 termin-variable" 
                           draggable="true" 
                           data-variable="{% verbatim %}{{firma_logo}}{% endverbatim %}"
                           style="cursor: pointer; user-select: none;"
                           title="Klicken oder per Drag & Drop einfügen"
                           onclick="insertTerminVariable('{% verbatim %}{{firma_logo}}{% endverbatim %}')">
                        <i class="ki-duotone ki-picture fs-6 me-1">
                          <span class="path1"></span>
                          <span class="path2"></span>
                        </i>
                        Logo
                      </div>
                      
                    </div>
                    
                    <!-- Text Formatting for Termin -->
                    <div class="mb-3">
                      <span class="text-muted small d-block mb-2">Text formatieren (Text auswählen und Button klicken):</span>
                      <div class="d-flex flex-wrap gap-2">
                        <button type="button" class="btn btn-sm btn-light-primary termin-format-btn" 
                                data-format="bold" title="Macht den ausgewählten Text fett">
                          <strong>Fett</strong>
                        </button>
                        <button type="button" class="btn btn-sm btn-light-primary termin-format-btn" 
                                data-format="italic" title="Macht den ausgewählten Text kursiv">
                          <em>Kursiv</em>
                        </button>
                        <button type="button" class="btn btn-sm btn-light-primary termin-format-btn" 
                                data-format="underline" title="Unterstreicht den ausgewählten Text">
                          <u>Unterstrichen</u>
                        </button>
                        <button type="button" class="btn btn-sm btn-light-success termin-format-btn" 
                                data-format="h1" title="Macht eine große Überschrift">
                          Große Überschrift
                        </button>
                        <button type="button" class="btn btn-sm btn-light-success termin-format-btn" 
                                data-format="h2" title="Macht eine mittlere Überschrift">
                          Mittlere Überschrift
                        </button>
                        <button type="button" class="btn btn-sm btn-light-warning termin-format-btn" 
                                data-format="center" title="Zentriert den Text">
                          Zentrieren
                        </button>
                        <button type="button" class="btn btn-sm btn-light-danger termin-format-btn" 
                                data-format="color" title="Ändert die Textfarbe">
                          Farbe ändern
                        </button>
                      </div>
                    </div>
                    
                    <!-- Preview Button for Termin -->
                    <div class="mb-3">
                      <button type="button" id="termin_preview_btn" class="btn btn-sm btn-light-info">
                        <i class="ki-duotone ki-eye fs-6 me-1">
                          <span class="path1"></span>
                          <span class="path2"></span>
                          <span class="path3"></span>
                        </i>
                        Termin E-Mail Vorschau
                      </button>
                    </div>
                    
                    <textarea id="termin_onay_editor" name="termin_onay_yazisi" rows="8"
                      class="form-control form-control-lg form-control-solid"
                      placeholder="Text für Termin-Bestätigungs-E-Mail ...">{% if firma and firma.termin_onay_yazisi %}{{ firma.termin_onay_yazisi }}{% endif %}</textarea>
                </div>

              </div>
              <div class="card-footer d-flex justify-content-end py-6 px-9">
                <a href="{% url 'firma_duzenle' %}" class="btn btn-light btn-active-light-primary me-2">Verwerfen</a>
                <button type="submit" class="btn btn-primary">Änderungen speichern</button>
              </div>
            </form>
          </div>
        </div>
        <!--end::Termin-Bestätigung-->
        {% endif %}

        {% if request.user.is_superuser or request.user.rol == 'Admin' %}
        <!--begin::Berechtigungen-->
        <div class="card mb-5 mb-xl-10">
          <div class="card-header border-0 cursor-pointer" role="button"
               data-bs-toggle="collapse" data-bs-target="#kt_berechtigungen_details"
               aria-expanded="true" aria-controls="kt_berechtigungen_details">
            <div class="card-title m-0">
              <h3 class="fw-bold m-0">Berechtigungen</h3>
            </div>
          </div>

          <div id="kt_berechtigungen_details" class="collapse show">

          </div>
        </div>
        <!--end::Berechtigungen-->
        {% endif %}

        {% if request.user.is_superuser or request.user.rol == 'Admin' %}
        <!--begin::SMTP-Einstellungen-->
        <div class="card mb-5 mb-xl-10">
          <div class="card-header border-0 cursor-pointer" role="button"
               data-bs-toggle="collapse" data-bs-target="#kt_smtp_details"
               aria-expanded="true" aria-controls="kt_smtp_details">
            <div class="card-title m-0">
              <h3 class="fw-bold m-0">SMTP-Einstellungen</h3>
            </div>
          </div>

          <div id="kt_smtp_details" class="collapse show">
            <form class="form fv-plugins-bootstrap5 fv-plugins-framework" method="post" novalidate>
              {% csrf_token %}
              <input type="hidden" name="form_type" value="smtp">
              <div class="card-body border-top p-9">

                <!-- Host -->
                <div class="row mb-6">
                  <label class="col-lg-4 col-form-label required fw-semibold fs-6">SMTP-Server</label>
                  <div class="col-lg-8 fv-row fv-plugins-icon-container">
                    {{ smtp_form.host }}
                    {% if smtp_form.host.errors %}
                      <div class="fv-plugins-message-container fv-plugins-message-container--enabled invalid-feedback d-block">
                        {{ smtp_form.host.errors|striptags }}
                      </div>
                    {% endif %}
                  </div>
                </div>

                <!-- Port -->
                <div class="row mb-6">
                  <label class="col-lg-4 col-form-label required fw-semibold fs-6">Port</label>
                  <div class="col-lg-8 fv-row fv-plugins-icon-container">
                    {{ smtp_form.port }}
                    {% if smtp_form.port.errors %}
                      <div class="fv-plugins-message-container fv-plugins-message-container--enabled invalid-feedback d-block">
                        {{ smtp_form.port.errors|striptags }}
                      </div>
                    {% endif %}
                  </div>
                </div>

                <!-- Benutzername -->
                <div class="row mb-6">
                  <label class="col-lg-4 col-form-label fw-semibold fs-6">Benutzername</label>
                  <div class="col-lg-8 fv-row fv-plugins-icon-container">
                    {{ smtp_form.username }}
                    {% if smtp_form.username.errors %}
                      <div class="fv-plugins-message-container fv-plugins-message-container--enabled invalid-feedback d-block">
                        {{ smtp_form.username.errors|striptags }}
                      </div>
                    {% endif %}
                  </div>
                </div>

                <!-- Passwort -->
                <div class="row mb-6">
                  <label class="col-lg-4 col-form-label fw-semibold fs-6">Passwort</label>
                  <div class="col-lg-8 fv-row fv-plugins-icon-container">
                    <div class="position-relative">
                      {{ smtp_form.password }}
                      <button type="button" class="btn btn-sm btn-icon position-absolute top-50 translate-middle-y end-0 me-3 password-toggle" data-password-toggle data-target="input[name='password']" style="cursor:pointer;"><i class="fa-solid fa-eye"></i><i class="fa-solid fa-eye-slash d-none"></i></button>
                    </div>

                    {% if smtp_form.password.errors %}
                      <div class="fv-plugins-message-container fv-plugins-message-container--enabled invalid-feedback d-block">
                        {{ smtp_form.password.errors|striptags }}
                      </div>
                    {% endif %}
                  </div>
                </div>

                <!-- Sicherheit -->
                <div class="row mb-0">
                  <label class="col-lg-4 col-form-label fw-semibold fs-6">Sicherheit</label>
                  <div class="col-lg-8 d-flex align-items-center gap-5">
                    <label class="form-check form-check-solid form-switch form-check-custom fv-row mb-0">
                      {{ smtp_form.use_tls }}
                      <span class="form-check-label ms-3">TLS verwenden</span>
                    </label>
                    <label class="form-check form-check-solid form-switch form-check-custom fv-row mb-0">
                      {{ smtp_form.use_ssl }}
                      <span class="form-check-label ms-3">SSL verwenden</span>
                    </label>
                  </div>
                </div>

              </div>
              <div class="card-footer d-flex justify-content-end py-6 px-9">
                <a href="{% url 'firma_duzenle' %}" class="btn btn-light btn-active-light-primary me-2">Verwerfen</a>
                <button type="submit" class="btn btn-primary">Änderungen speichern</button>
              </div>
            </form>
          </div>
        </div>
        <!--end::SMTP-Einstellungen-->
        {% endif %}

        <!--begin::Formstatus-Einstellungen-->
        <div class="card mb-5 mb-xl-10">
          <div class="card-header border-0 cursor-pointer" role="button"
              data-bs-toggle="collapse" data-bs-target="#kt_formstatus_details"
              aria-expanded="true" aria-controls="kt_formstatus_details">
            <div class="card-title m-0">
              <h3 class="fw-bold m-0">Formstatus verwalten</h3>
            </div>
          </div>

          <div id="kt_formstatus_details" class="collapse show">
            <form class="form" method="post" novalidate id="formstatus_form">
              {% csrf_token %}
              <input type="hidden" name="form_type" value="durum">

              <div class="card-body border-top p-9">
                <div class="d-flex justify-content-between align-items-center mb-6">
                  <button type="button" class="btn btn-light-primary" id="btn_status_ekle">
                    <i class="fa-solid fa-plus me-2"></i>Neuen Status hinzufügen
                  </button>
                </div>

                <div class="row g-4" id="status_liste">
                  {% for d in form_durumlari %}
                    <div class="col-12 status-item">
                      <div class="d-flex align-items-center rounded border p-3 bg-light position-relative">
                        <!-- Gizli ID -->
                        <input type="hidden" name="durum_id[]" value="{{ d.id }}">

                        <!-- İsim -->
                        <div class="flex-grow-1">
                          <input type="text" name="durum_isim[]" value="{{ d.isim }}" class="form-control" required maxlength="50">
                        </div>

                        <!-- Oklar + Sil -->
                        <div class="ms-3 d-flex align-items-center gap-2">
                          <button type="button" class="btn btn-light btn-sm btn-up"   title="Nach oben">
                            <i class="fa-solid fa-arrow-up"></i>
                          </button>
                          <button type="button" class="btn btn-light btn-sm btn-down" title="Nach unten">
                            <i class="fa-solid fa-arrow-down"></i>
                          </button>
                          <button type="button" class="btn btn-light-danger btn-sm btn_status_sil" title="Löschen">
                            <i class="fa-solid fa-trash"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  {% empty %}
                    <div class="col-12 status-item">
                      <div class="d-flex align-items-center rounded border p-3 bg-light position-relative">
                        <input type="hidden" name="durum_id[]" value="">
                        <div class="col-auto pe-3">
                          <span class="badge bg-secondary-subtle text-secondary fw-semibold status-badge">Status 1</span>
                        </div>
                        <div class="flex-grow-1">
                          <input type="text" name="durum_isim[]" class="form-control" required maxlength="50">
                        </div>
                        <div class="ms-3 d-flex align-items-center gap-2">
                          <button type="button" class="btn btn-light btn-sm btn-up" title="Nach oben">
                            <i class="fa-solid fa-arrow-up"></i>
                          </button>
                          <button type="button" class="btn btn-light btn-sm btn-down" title="Nach unten">
                            <i class="fa-solid fa-arrow-down"></i>
                          </button>
                          <button type="button" class="btn btn-light-danger btn-sm btn_status_sil" title="Löschen">
                            <i class="fa-solid fa-trash"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                </div>

                <div class="form-text mt-4">
                  Doppelte Namen sind nicht erlaubt. Max. 50 Zeichen.
                </div>
              </div>

              <div class="card-footer d-flex justify-content-end py-6 px-9">
                <a href="{% url 'firma_duzenle' %}" class="btn btn-light btn-active-light-primary me-2">Verwerfen</a>
                <button type="submit" class="btn btn-primary">Änderungen speichern</button>
              </div>
            </form>
          </div>
        </div>
        <!--end::Formstatus-Einstellungen-->

        <!--begin::Versicherungsgesellschaften-Einstellungen-->
        <div class="card mb-5 mb-xl-10">
          <div class="card-header border-0 cursor-pointer" role="button"
              data-bs-toggle="collapse" data-bs-target="#kt_sigorta_details"
              aria-expanded="true" aria-controls="kt_sigorta_details">
            <div class="card-title m-0">
              <h3 class="fw-bold m-0">Versicherungsgesellschaften verwalten</h3>
            </div>
          </div>

          <div id="kt_sigorta_details" class="collapse show">
            <form class="form" method="post" enctype="multipart/form-data" novalidate id="sigorta_form">
              {% csrf_token %}
              <input type="hidden" name="form_type" value="sigorta">

              <div class="card-body border-top p-9">
                <div class="d-flex justify-content-between align-items-center mb-6">
                  <button type="button" class="btn btn-light-primary" id="btn_sigorta_ekle">
                    <i class="fa-solid fa-plus me-2"></i>Neue Gesellschaft hinzufügen
                  </button>
                </div>

                <div class="row g-4" id="sigorta_liste">
                  {% for s in sigorta_sirketleri %}
                    <div class="col-12 sigorta-item" data-item-id="{{ s.id }}">
                      <div class="item-wrap position-relative">
                        <!-- Gizli ID + Resim Sil Flag + Unique Key -->
                        <input type="hidden" name="ss_id[]" value="{{ s.id }}">
                        <input type="hidden" name="ss_resim_sil[]" value="0" class="del-flag">
                        <input type="hidden" name="ss_key[]" value="existing_{{ s.id }}" data-item-id="{{ s.id }}">

                        <!-- Logo -->
                        <div class="symbol me-4 flex-shrink-0">
                          {% if s.resim %}
                            <img src="{{ s.resim.url }}" alt="{{ s.isim }} Logo" class="rounded-2 logo-preview" loading="lazy">
                          {% else %}
                            <div class="d-flex align-items-center justify-content-center w-100 h-100 rounded-2 bg-light text-muted small logo-placeholder">
                              Logo
                            </div>
                          {% endif %}
                        </div>

                        <!-- İsim ve Kapsam -->
                        <div class="name-col me-3">
                          <input type="text" name="ss_isim[]" value="{{ s.isim }}" class="form-control mb-2" required maxlength="255" placeholder="Name der Versicherungsgesellschaft">
                          <select name="ss_kapsam[]" class="form-select form-select-sm">
                            <option value="Privat" {% if s.kapsam == 'Privat' %}selected{% endif %}>Privat</option>
                            <option value="Gesetzlich" {% if s.kapsam == 'Gesetzlich' %}selected{% endif %}>Gesetzlich</option>
                            <option value="Beides" {% if s.kapsam == 'Beides' %}selected{% endif %}>Beides</option>
                          </select>
                        </div>

                        <!-- Dosya + Sil checkbox + Oklar/Sil -->
                        <div class="ctrl-col">
                          <div class="file-block">
                            <input type="file" name="ss_resim_{{ s.id }}" accept="image/*" class="form-control form-control-sm logo-file" data-item-id="{{ s.id }}">
                          </div>
                          <button type="button" class="btn btn-outline-danger btn-sm del-image-btn" data-item-id="{{ s.id }}" title="Logo entfernen">
                            <i class="fa-solid fa-image me-1"></i>Logo entfernen
                          </button>

                          <div class="actions">
                            <button type="button" class="btn btn-light btn-sm btn-up" title="Nach oben" data-item-id="{{ s.id }}">
                              <i class="fa-solid fa-arrow-up"></i>
                            </button>
                            <button type="button" class="btn btn-light btn-sm btn-down" title="Nach unten" data-item-id="{{ s.id }}">
                              <i class="fa-solid fa-arrow-down"></i>
                            </button>
                            <button type="button" class="btn btn-light-danger btn-sm btn_sigorta_sil" title="Löschen" data-item-id="{{ s.id }}">
                              <i class="fa-solid fa-trash"></i>
                            </button>
                            <button type="button" class="btn btn-light btn-sm btn-alt" data-sirket-id="{{ s.id }}" data-sirket-isim="{{ s.isim }}" title="Untergesellschaften verwalten">
                              <i class="fa-solid fa-sitemap"></i>
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>

                  {% empty %}
                    <!-- İlk satır (boş başlangıç) -->
                    <div class="col-12 sigorta-item" data-item-id="new_0">
                      <div class="item-wrap position-relative">
                        <input type="hidden" name="ss_id[]" value="">
                        <input type="hidden" name="ss_resim_sil[]" value="0" class="del-flag">
                        <input type="hidden" name="ss_key[]" value="new_0" data-item-id="new_0">

                        <!-- Logo -->
                        <div class="symbol me-4 flex-shrink-0">
                          <div class="d-flex align-items-center justify-content-center w-100 h-100 rounded-2 bg-light text-muted small logo-placeholder">
                            Logo
                          </div>
                        </div>

                        <!-- İsim ve Kapsam -->
                        <div class="name-col me-3">
                          <input type="text" name="ss_isim[]" class="form-control mb-2" required maxlength="255" placeholder="Name der Versicherungsgesellschaft">
                          <select name="ss_kapsam[]" class="form-select form-select-sm">
                            <option value="Privat">Privat</option>
                            <option value="Gesetzlich">Gesetzlich</option>
                            <option value="Beides" selected>Beides</option>
                          </select>
                        </div>

                        <!-- Dosya + Sil checkbox + Oklar/Sil -->
                        <div class="ctrl-col">
                          <div class="file-block">
                            <input type="file" name="ss_resim_new_0" accept="image/*" class="form-control form-control-sm logo-file" data-item-id="new_0">
                          </div>
                          <button type="button" class="btn btn-outline-danger btn-sm del-image-btn" data-item-id="new_0" title="Logo entfernen">
                            <i class="fa-solid fa-image me-1"></i>Logo entfernen
                          </button>

                          <div class="actions">
                            <button type="button" class="btn btn-light btn-sm btn-up" title="Nach oben" data-item-id="new_0">
                              <i class="fa-solid fa-arrow-up"></i>
                            </button>
                            <button type="button" class="btn btn-light btn-sm btn-down" title="Nach unten" data-item-id="new_0">
                              <i class="fa-solid fa-arrow-down"></i>
                            </button>
                            <button type="button" class="btn btn-light-danger btn-sm btn_sigorta_sil" title="Löschen" data-item-id="new_0">
                              <i class="fa-solid fa-trash"></i>
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                </div>

                <div class="form-text mt-4">
                  Doppelte Namen sind nicht erlaubt. Max. 255 Zeichen. Logos werden automatisch skaliert.
                </div>
              </div>

              <div class="card-footer d-flex justify-content-end py-6 px-9">
                <a href="{% url 'firma_duzenle' %}" class="btn btn-light btn-active-light-primary me-2">Verwerfen</a>
                <button type="submit" class="btn btn-primary">Änderungen speichern</button>
              </div>
            </form>
          </div>
        </div>
        <!--end::Versicherungsgesellschaften-Einstellungen-->

        <!--begin::Untergesellschaften-Modal-->
        <div class="modal fade" id="modal_alt_sirket" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">
                  Untergesellschaften von: <span id="as_modal_title" class="fw-semibold"></span>
                </h5>
                <button type="button" class="btn btn-icon" data-bs-dismiss="modal" aria-label="Schließen">
                  <i class="fa-solid fa-xmark"></i>
                </button>
              </div>

              <form id="as_form" method="post" novalidate>
                {% csrf_token %}
                <input type="hidden" name="sirket_id" id="as_sirket_id" value="">

                <div class="modal-body">
                  <div class="d-flex justify-content-between align-items-center mb-4">
                    <button type="button" class="btn btn-light-primary" id="as_btn_ekle">
                      <i class="fa-solid fa-plus me-2"></i>Neue Untergesellschaft hinzufügen
                    </button>
                  </div>

                  <div class="row g-3" id="as_liste"></div>

                  <div class="form-text mt-3">
                    Leere Liste absenden löscht alle Untergesellschaften. Doppelte Namen sind nicht erlaubt.
                  </div>

                  <div class="alert alert-danger d-none mt-3" id="as_error"></div>
                  <div class="alert alert-success d-none mt-3" id="as_success"></div>
                </div>

                <div class="modal-footer">
                  <button type="button" class="btn btn-light" data-bs-dismiss="modal">Schließen</button>
                  <button type="submit" class="btn btn-primary">Speichern</button>
                </div>
              </form>
            </div>
          </div>
        </div>
        <!--end::Untergesellschaften-Modal-->


        {% if request.user.is_superuser or request.user.rol == 'Admin' %}
        <!--begin::Footer-Bearbeiten (Frontend-Only, CKEditor CDN)-->
        <div class="card mb-5 mb-xl-10">
          <div class="card-header border-0 cursor-pointer" role="button"
              data-bs-toggle="collapse" data-bs-target="#kt_footer_details"
              aria-expanded="true" aria-controls="kt_footer_details">
            <div class="card-title m-0">
              <h3 class="fw-bold m-0">Footer bearbeiten</h3>
            </div>
          </div>

          <div id="kt_footer_details" class="collapse show">
            <form class="form fv-plugins-bootstrap5 fv-plugins-framework" method="post" novalidate id="footer_form">
              {% csrf_token %}
              <input type="hidden" name="form_type" value="footer">

              <!-- Gizli gerçek alanlar (POST bunlarla gider) -->
              <input type="hidden" name="icerik_sol" id="footer_left_input">
              <input type="hidden" name="buton_yazi_sag" id="btn_right_label_input">
              <input type="hidden" name="buton_modal_icerik_sag" id="btn_right_modal_input">
              <input type="hidden" name="buton_yazi_sag_iki" id="btn_right2_label_input">
              <input type="hidden" name="buton_modal_icerik_sag_iki" id="btn_right2_modal_input">

              <div class="card-body border-top p-9">
                <div class="row g-10">
                  <!-- Linker Inhalt -->
                  <div class="col-12 col-lg-4">
                    <label class="form-label fw-semibold fs-6">Linker Inhalt</label>
                    <div class="border rounded bg-light p-2">
                      <div id="footer_left_editor" class="ck-editor-wrap" style="min-height: 200px;">
                        {{ footer.icerik_sol|default_if_none:""|safe }}
                      </div>
                    </div>
                    <div class="form-text">Nutze Absätze, Listen und Links für gute Lesbarkeit.</div>
                  </div>

                  <!-- Rechter Button + Modal -->
                  <div class="col-12 col-lg-4">
                    <label class="form-label fw-semibold fs-6">Rechter Modal-Inhalt</label>
                    <div class="border rounded bg-light p-2">
                      <div id="btn_right_modal_editor" class="ck-editor-wrap" style="min-height: 200px;">
                        {{ footer.buton_modal_icerik_sag|default_if_none:""|safe }}
                      </div>
                    </div>
                    <div class="form-text">Inhalt, der im Modal angezeigt wird.</div>
                    <label class="form-label fw-semibold fs-6 mt-5">Rechter Button</label>
                    <input type="text" class="form-control mb-3" id="btn_right_label_editor"
                          placeholder="Button-Text"
                          value="{{ footer.buton_yazi_sag|default_if_none:'' }}">
                    <div class="form-text mb-3">Beschriftung des rechten Buttons.</div>
                  </div>

                  <!-- Rechter Button (zweite Spalte) + Modal -->
                  <div class="col-12 col-lg-4">
                    <label class="form-label fw-semibold fs-6">Zweiter Modal-Inhalt</label>
                    <div class="border rounded bg-light p-2">
                      <div id="btn_right2_modal_editor" class="ck-editor-wrap" style="min-height: 200px;">
                        {{ footer.buton_modal_icerik_sag_iki|default_if_none:""|safe }}
                      </div>
                    </div>
                    <div class="form-text">Inhalt für das zweite Modal (optional).</div>
                    <label class="form-label fw-semibold fs-6 mt-5">Rechter Button (Spalte 2)</label>
                    <input type="text" class="form-control mb-3" id="btn_right2_label_editor"
                          placeholder="Zweiter Button-Text (optional)"
                          value="{{ footer.buton_yazi_sag_iki|default_if_none:'' }}">
                    <div class="form-text mb-3">Optionaler zweiter Button rechts.</div>
                  </div>
                </div>
              </div>

              <div class="card-footer d-flex justify-content-end py-6 px-9">
                <a href="{% url 'firma_duzenle' %}" class="btn btn-light btn-active-light-primary me-2">Verwerfen</a>
                <button type="submit" class="btn btn-primary">Änderungen speichern</button>
              </div>
            </form>
          </div>
        </div>
        <!--end::Footer-Bearbeiten-->
        {% endif %}

      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block script %}
{# --- Canlı önizleme JS --- #}
<script>
  (function () {
    function bindPreview(inputId, imgId) {
      var input = document.getElementById(inputId);
      var img = document.getElementById(imgId);
      if (!input || !img) return;

      input.addEventListener('change', function (e) {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        const url = URL.createObjectURL(file);
        img.src = url;
        img.classList.remove('opacity-50');
      });
    }

    document.addEventListener('DOMContentLoaded', function () {
      bindPreview('id_logo', 'logoPreview');
      bindPreview('id_icon', 'iconPreview');
    });
  })();
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  // Input'a sağ padding ekle (ikon çakışmasın)
  document.querySelectorAll('[data-password-toggle]').forEach(function (btn) {
    const wrap = btn.closest('.position-relative');
    const targetSel = btn.getAttribute('data-target');
    const input = (wrap && targetSel && wrap.querySelector(targetSel)) ||
                  (wrap && wrap.querySelector('input[type="password"], input[type="text"]'));
    if (input) input.classList.add('pe-12');
  });

  // Tıklama ile göster/gizle
  document.addEventListener("click", function (e) {
    const btn = e.target.closest('[data-password-toggle]');
    if (!btn) return;

    const wrap = btn.closest('.position-relative');
    const targetSel = btn.getAttribute('data-target');
    const input = (wrap && targetSel && wrap.querySelector(targetSel)) ||
                  (wrap && wrap.querySelector('input[type="password"], input[type="text"]'));
    if (!input) return;

    const eye = btn.querySelector(".fa-eye");
    const eyeSlash = btn.querySelector(".fa-eye-slash");

    if (input.type === "password") {
      input.type = "text";
      if (eye) eye.classList.add("d-none");
      if (eyeSlash) eyeSlash.classList.remove("d-none");
    } else {
      input.type = "password";
      if (eye) eye.classList.remove("d-none");
      if (eyeSlash) eyeSlash.classList.add("d-none");
    }
  });
});
</script>
<script>
(function () {
  const list   = document.getElementById('status_liste');
  const addBtn = document.getElementById('btn_status_ekle');
  const form   = document.getElementById('formstatus_form');

  if (!list) return;

  function relabel() {
    list.querySelectorAll('.status-item').forEach((wrap, idx) => {
      const badge = wrap.querySelector('.status-badge');
      if (badge) badge.textContent = `Status ${idx + 1}`;
    });
  }

  function moveUp(item) {
    const prev = item.previousElementSibling;
    if (prev && prev.classList.contains('status-item')) {
      list.insertBefore(item, prev);
      relabel();
    }
  }

  function moveDown(item) {
    const next = item.nextElementSibling;
    if (next && next.classList.contains('status-item')) {
      list.insertBefore(next, item); // swap
      relabel();
    }
  }

  function newRow(nameVal = '', idVal = '') {
    const col = document.createElement('div');
    col.className = 'col-12 status-item';
    col.innerHTML = `
      <div class="d-flex align-items-center rounded border p-3 bg-light position-relative">
        <input type="hidden" name="durum_id[]" value="${idVal}">
        <div class="flex-grow-1">
          <input type="text" name="durum_isim[]" class="form-control" required maxlength="50" value="${nameVal}">
        </div>
        <div class="ms-3 d-flex align-items-center gap-2">
          <button type="button" class="btn btn-light btn-sm btn-up" title="Nach oben">
            <i class="fa-solid fa-arrow-up"></i>
          </button>
          <button type="button" class="btn btn-light btn-sm btn-down" title="Nach unten">
            <i class="fa-solid fa-arrow-down"></i>
          </button>
          <button type="button" class="btn btn-light-danger btn-sm btn_status_sil" title="Löschen">
            <i class="fa-solid fa-trash"></i>
          </button>
        </div>
      </div>`;
    list.appendChild(col);
    relabel();
  }

  // Liste içi butonlar (delegation)
  list.addEventListener('click', (e) => {
    const upBtn   = e.target.closest('.btn-up');
    const downBtn = e.target.closest('.btn-down');
    const delBtn  = e.target.closest('.btn_status_sil');
    const item    = e.target.closest('.status-item');

    if (!item) return;

    if (upBtn)   return moveUp(item);
    if (downBtn) return moveDown(item);
    if (delBtn) {
      const total = list.querySelectorAll('.status-item').length;
      if (total <= 1) {
        item.remove();
        asRelabel();
        return;
      }
      item.remove();
      relabel();
    }
  });

  // Yeni satır ekle
  addBtn?.addEventListener('click', () => newRow());

  // Submit validasyonu (boş & tekrar isim)
  form?.addEventListener('submit', (e) => {
    const inputs = Array.from(form.querySelectorAll('input[name="durum_isim[]"]'));
    const names  = inputs.map(i => (i.value || '').trim()).filter(Boolean);

    if (names.length !== inputs.length) {
      e.preventDefault();
      alert('Bitte fülle alle Status-Namen aus.');
      return;
    }
    const lower = names.map(n => n.toLowerCase());
    const hasDup = lower.some((n, i) => lower.indexOf(n) !== i);
    if (hasDup) {
      e.preventDefault();
      alert('Doppelte Status-Namen sind nicht erlaubt.');
      return;
    }
    // DOM sırası backend’de sira=1..N olarak kaydedilecek.
  });

  relabel();
})();
</script>

<!-- E-Mail Editor Script (Herkes için) -->
<script>
/* =================== E-Mail (Bestätigungstext) DRAG & DROP ENTEGRASYONU =================== */
(function(){
  const emailForm    = document.getElementById('email_form');
  const emailEditorEl= document.getElementById('email_onay_editor');
  
  if (!emailForm || !emailEditorEl) {
    return;
  }

  // Global function to insert variables into email editor
  window.insertEmailVariable = function(variable) {
    if (!variable || variable.length === 0) {
      alert('Hata: Variable boş geldi!');
      return;
    }
    
    try {
      // Textarea için basit ekleme
      const currentValue = emailEditorEl.value;
      const cursorPos = emailEditorEl.selectionStart || 0;
      
      const newValue = currentValue.substring(0, cursorPos) + variable + currentValue.substring(cursorPos);
      emailEditorEl.value = newValue;
      
      emailEditorEl.focus();
      emailEditorEl.setSelectionRange(cursorPos + variable.length, cursorPos + variable.length);
    } catch (error) {
      console.error('insertEmailVariable hatası:', error);
    }
  };

  // Text formatting functions
  window.formatEmailText = function(format) {
    try {
      const textarea = emailEditorEl;
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const selectedText = textarea.value.substring(start, end);
      
      if (selectedText.length === 0) {
        alert('Bitte wählen Sie zuerst Text aus!\n\nSo geht\'s:\n1. Text mit der Maus auswählen\n2. Auf Format-Button klicken');
        return;
      }
      
      let formattedText = selectedText;
      
      switch(format) {
        case 'bold':
          formattedText = `<strong>${selectedText}</strong>`;
          break;
        case 'italic':
          formattedText = `<em>${selectedText}</em>`;
          break;
        case 'underline':
          formattedText = `<u>${selectedText}</u>`;
          break;
        case 'h1':
          formattedText = `<h1>${selectedText}</h1>`;
          break;
        case 'h2':
          formattedText = `<h2>${selectedText}</h2>`;
          break;
        case 'center':
          formattedText = `<div style="text-align: center;">${selectedText}</div>`;
          break;
        case 'color':
          showColorPicker(selectedText, start, end);
          return; // Don't continue with normal formatting
          break;
        default:
          return;
      }
      
      // Replace selected text with formatted text
      const newValue = textarea.value.substring(0, start) + formattedText + textarea.value.substring(end);
      textarea.value = newValue;
      
      // Set cursor position after formatted text
      textarea.focus();
      textarea.setSelectionRange(start + formattedText.length, start + formattedText.length);
      
    } catch (error) {
      console.error('formatEmailText hatası:', error);
    }
  };

  // Drag & Drop functionality
  function setupDragAndDrop() {
    console.log('🔧 setupDragAndDrop başladı');
    const emailVariables = document.querySelectorAll('.email-variable');
    console.log('📋 Bulunan email-variable elementleri:', emailVariables.length, emailVariables);
    
    if (emailVariables.length === 0) {
      console.error('❌ Hiç .email-variable elementi bulunamadı!');
      return;
    }
    
    emailVariables.forEach(function(variable, index) {
      console.log(`📝 Element ${index + 1}:`, variable, 'data-variable:', variable.getAttribute('data-variable'));
      
      // Drag start
      variable.addEventListener('dragstart', function(e) {
        console.log('🚀 Drag başladı, element:', this);
        const variableText = this.getAttribute('data-variable');
        console.log('📦 Sürüklenen değişken:', variableText);
        e.dataTransfer.setData('text/plain', variableText);
        e.dataTransfer.effectAllowed = 'copy';
        this.style.opacity = '0.5';
        this.style.cursor = 'grabbing';
      });

      // Drag end
      variable.addEventListener('dragend', function(e) {
        console.log('🏁 Drag bitti');
        this.style.opacity = '1';
        this.style.cursor = 'grab';
      });
    });

    // Make textarea droppable
    emailEditorEl.addEventListener('dragover', function(e) {
      console.log('📍 Dragover event');
      e.preventDefault();
      e.dataTransfer.dropEffect = 'copy';
      this.style.borderColor = '#1976d2';
      this.style.backgroundColor = '#f8f9ff';
    });

    emailEditorEl.addEventListener('dragleave', function(e) {
      console.log('📤 Dragleave event');
      this.style.borderColor = '';
      this.style.backgroundColor = '';
    });

    emailEditorEl.addEventListener('drop', function(e) {
      console.log('🎯 Drop event tetiklendi!');
      e.preventDefault();
      const variable = e.dataTransfer.getData('text/plain');
      console.log('📦 Alınan data:', variable);
        
        try {
          const textarea = this;
          
          // Mouse koordinatlarından karakter pozisyonu hesapla
          const rect = textarea.getBoundingClientRect();
          const x = e.clientX - rect.left - parseInt(getComputedStyle(textarea).paddingLeft);
          const y = e.clientY - rect.top - parseInt(getComputedStyle(textarea).paddingTop);
          
          // Font ve satır bilgilerini al
          const style = getComputedStyle(textarea);
          const fontSize = parseInt(style.fontSize);
          const lineHeight = parseInt(style.lineHeight) || fontSize * 1.2;
          
          // Yaklaşık satır numarasını hesapla
          const lineNumber = Math.max(0, Math.floor((y + textarea.scrollTop) / lineHeight));
          
          // Metni satırlara böl
          const lines = textarea.value.split('\n');
          let targetPosition = 0;
          
          if (lineNumber >= lines.length) {
            // Son satırın sonuna git
            targetPosition = textarea.value.length;
          } else {
            // Hedef satıra kadar olan karakterleri say
            for (let i = 0; i < lineNumber; i++) {
              targetPosition += lines[i].length + 1; // +1 for \n
            }
            
            // Satır içindeki yaklaşık pozisyonu hesapla
            const avgCharWidth = fontSize * 0.6; // Ortalama karakter genişliği
            const charInLine = Math.max(0, Math.floor((x + textarea.scrollLeft) / avgCharWidth));
            const maxCharInLine = lines[lineNumber] ? lines[lineNumber].length : 0;
            
            targetPosition += Math.min(charInLine, maxCharInLine);
          }
          
          // Değişkeni hesaplanan pozisyona ekle
          const currentValue = textarea.value;
          const newValue = currentValue.substring(0, targetPosition) + variable + currentValue.substring(targetPosition);
          textarea.value = newValue;
          
          // Cursor'u eklenen değişkenin sonuna getir
          textarea.focus();
          textarea.setSelectionRange(targetPosition + variable.length, targetPosition + variable.length);
          console.log('✅ Drop işlemi başarılı! Pozisyon:', targetPosition);
        } catch (error) {
          console.error('❌ Drop hatası:', error);
          // Fallback: cursor pozisyonuna ekle
          const currentValue = this.value;
          const cursorPos = this.selectionStart || 0;
          this.value = currentValue.substring(0, cursorPos) + variable + currentValue.substring(cursorPos);
          this.focus();
          this.setSelectionRange(cursorPos + variable.length, cursorPos + variable.length);
          console.log('✅ Fallback drop işlemi başarılı! Cursor pozisyon:', cursorPos);
        }
        
        this.style.borderColor = '';
        this.style.backgroundColor = '';
      });
  }

  // Initialize drag & drop
  setupDragAndDrop();
  
  // Setup formatting toolbar
  function setupFormatting() {
    const formatButtons = document.querySelectorAll('.email-format-btn');
    formatButtons.forEach(button => {
      button.addEventListener('click', function(e) {
        e.preventDefault();
        const format = this.getAttribute('data-format');
        formatEmailText(format);
      });
    });
  }
  
  setupFormatting();
  
  // Email Preview functionality
  function setupEmailPreview() {
    const previewBtn = document.getElementById('email_preview_btn');
    const previewModal = document.getElementById('emailPreviewModal');
    const previewContent = document.getElementById('emailPreviewContent');
    
    if (!previewBtn || !previewModal || !previewContent) return;
    
    previewBtn.addEventListener('click', function() {
      // Get current email text
      let emailText = emailEditorEl.value.trim();
      
      if (!emailText) {
        emailText = 'E-Mail-Inhalt ist leer...';
      }
      
      // Sample data for preview
      const sampleData = {
        '{% verbatim %}{{code}}{% endverbatim %}': '<span style="background: #e3f2fd; padding: 8px 16px; border-radius: 4px; font-family: monospace; font-size: 18px; font-weight: bold; color: #1976d2; border: 2px dashed #1976d2;">562797</span>',
        '{% verbatim %}{{firma_name}}{% endverbatim %}': '{% if firma and firma.isim %}{{ firma.isim }}{% else %}Dogu Merkur{% endif %}',
        '{% verbatim %}{{firma_phone}}{% endverbatim %}': '{% if firma and firma.telefon %}{{ firma.telefon }}{% else %}+49 123 456 7890{% endif %}',
        '{% verbatim %}{{firma_address}}{% endverbatim %}': '{% if firma and firma.adres %}{{ firma.adres }}{% else %}Musterstraße 123, 12345 Berlin{% endif %}',
        '{% verbatim %}{{customer_name}}{% endverbatim %}': 'Mustafa Müller',
        '{% verbatim %}{{firma_logo}}{% endverbatim %}': '{% if firma and firma.logo %}<img src="{{ firma.logo.url }}" alt="Logo" style="max-width:150px;height:auto;display:block;margin:10px 0;">{% else %}<div style="background: #f5f5f5; border: 2px dashed #ccc; padding: 20px; text-align: center; color: #666; border-radius: 4px; margin: 10px 0;">Logo burada görünecek</div>{% endif %}'
      };
      
      // Replace variables with sample data
      let previewText = emailText;
      for (const [variable, value] of Object.entries(sampleData)) {
        previewText = previewText.replace(new RegExp(variable.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), value);
      }
      
      // Convert newlines to <br> for HTML display
      previewText = previewText.replace(/\n/g, '<br>');
      
      // Set preview content
      previewContent.innerHTML = previewText;
      
      // Show modal
      const modal = new bootstrap.Modal(previewModal);
      modal.show();
    });
  }
  
  setupEmailPreview();
  
  // Color picker functionality
  function showColorPicker(selectedText, start, end) {
    const colorModal = document.getElementById('colorPickerModal');
    const selectedTextPreview = document.getElementById('selectedTextPreview');
    const colorPreview = document.getElementById('colorPreview');
    const applyColorBtn = document.getElementById('applyColorBtn');
    const customColorInput = document.getElementById('customColorInput');
    const customColorText = document.getElementById('customColorText');
    
    if (!colorModal) return;
    
    // Set selected text preview
    selectedTextPreview.textContent = selectedText;
    colorPreview.textContent = selectedText;
    
    let selectedColor = '#0d6efd';
    
    // Color palette click handlers
    document.querySelectorAll('.color-option').forEach(option => {
      option.addEventListener('click', function() {
        // Remove previous selection
        document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
        // Add selection to clicked option
        this.classList.add('selected');
        
        selectedColor = this.getAttribute('data-color');
        colorPreview.style.color = selectedColor;
        customColorInput.value = selectedColor;
        customColorText.value = selectedColor;
      });
    });
    
    // Custom color input handlers
    customColorInput.addEventListener('input', function() {
      selectedColor = this.value;
      colorPreview.style.color = selectedColor;
      customColorText.value = selectedColor;
      // Remove palette selections
      document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
    });
    
    customColorText.addEventListener('input', function() {
      const color = this.value;
      if (/^#[0-9A-F]{6}$/i.test(color)) {
        selectedColor = color;
        colorPreview.style.color = selectedColor;
        customColorInput.value = selectedColor;
        // Remove palette selections
        document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
      }
    });
    
    // Apply color button
    applyColorBtn.onclick = function() {
      const formattedText = `<span style="color: ${selectedColor};">${selectedText}</span>`;
      
      // Replace selected text with formatted text
      const newValue = emailEditorEl.value.substring(0, start) + formattedText + emailEditorEl.value.substring(end);
      emailEditorEl.value = newValue;
      
      // Set cursor position after formatted text
      emailEditorEl.focus();
      emailEditorEl.setSelectionRange(start + formattedText.length, start + formattedText.length);
      
      // Close modal
      const modal = bootstrap.Modal.getInstance(colorModal);
      modal.hide();
    };
    
    // Show modal
    const modal = new bootstrap.Modal(colorModal);
    modal.show();
  }

  emailForm.addEventListener('submit', function(e){
    // Form submit - no special handling needed
  });
})();

/* =================== TERMIN (Termin Bestätigung) DRAG & DROP ENTEGRASYONU =================== */
(function(){
  const terminForm    = document.getElementById('termin_form');
  const terminEditorEl= document.getElementById('termin_onay_editor');
  
  if (!terminForm || !terminEditorEl) {
    return;
  }

  // Global function to insert variables into termin editor
  window.insertTerminVariable = function(variable) {
    if (!variable || variable.length === 0) {
      alert('Hata: Variable boş geldi!');
      return;
    }
    
    try {
      // Textarea için basit ekleme
      const currentValue = terminEditorEl.value;
      const cursorPos = terminEditorEl.selectionStart || 0;
      
      const newValue = currentValue.substring(0, cursorPos) + variable + currentValue.substring(cursorPos);
      terminEditorEl.value = newValue;
      
      terminEditorEl.focus();
      terminEditorEl.setSelectionRange(cursorPos + variable.length, cursorPos + variable.length);
    } catch (error) {
      console.error('insertTerminVariable hatası:', error);
    }
  };

  // Text formatting functions for termin
  window.formatTerminText = function(format) {
    try {
      const textarea = terminEditorEl;
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const selectedText = textarea.value.substring(start, end);
      
      if (selectedText.length === 0) {
        alert('Bitte wählen Sie zuerst Text aus!\n\nSo geht\'s:\n1. Text mit der Maus auswählen\n2. Auf Format-Button klicken');
        return;
      }
      
      let formattedText = selectedText;
      
      switch(format) {
        case 'bold':
          formattedText = `<strong>${selectedText}</strong>`;
          break;
        case 'italic':
          formattedText = `<em>${selectedText}</em>`;
          break;
        case 'underline':
          formattedText = `<u>${selectedText}</u>`;
          break;
        case 'h1':
          formattedText = `<h1>${selectedText}</h1>`;
          break;
        case 'h2':
          formattedText = `<h2>${selectedText}</h2>`;
          break;
        case 'center':
          formattedText = `<div style="text-align: center;">${selectedText}</div>`;
          break;
        case 'color':
          showTerminColorPicker(selectedText, start, end);
          return; // Don't continue with normal formatting
          break;
        default:
          return;
      }
      
      // Replace selected text with formatted text
      const newValue = textarea.value.substring(0, start) + formattedText + textarea.value.substring(end);
      textarea.value = newValue;
      
      // Set cursor position after formatted text
      textarea.focus();
      textarea.setSelectionRange(start + formattedText.length, start + formattedText.length);
      
    } catch (error) {
      console.error('formatTerminText hatası:', error);
    }
  };

  // Drag & Drop functionality for termin
  function setupTerminDragAndDrop() {
    const terminVariables = document.querySelectorAll('.termin-variable');
    
    if (terminVariables.length === 0) {
      return;
    }
    
    terminVariables.forEach(function(variable) {
      // Drag start
      variable.addEventListener('dragstart', function(e) {
        const varText = this.getAttribute('data-variable');
        e.dataTransfer.setData('text/plain', varText);
      });
      
      // Drag end
      variable.addEventListener('dragend', function(e) {
        this.style.backgroundColor = '';
      });
    });

    // Drop zone setup
    terminEditorEl.addEventListener('dragover', function(e) {
      e.preventDefault();
      this.style.backgroundColor = '#f0f9ff';
    });

    terminEditorEl.addEventListener('dragleave', function(e) {
      this.style.backgroundColor = '';
    });

    terminEditorEl.addEventListener('drop', function(e) {
      e.preventDefault();
      const variable = e.dataTransfer.getData('text/plain');
      this.style.backgroundColor = '';
      
      if (!variable) return;
      
      try {
        // Mouse pozisyonuna göre insertion point hesapla
        const rect = this.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        // Tahmini karakter pozisyonu hesapla
        const computedStyle = window.getComputedStyle(this);
        const fontSize = parseFloat(computedStyle.fontSize);
        const lineHeight = parseFloat(computedStyle.lineHeight) || fontSize * 1.2;
        
        const charWidth = fontSize * 0.6; // Tahmini karakter genişliği
        const lineIndex = Math.floor(y / lineHeight);
        const charInLine = Math.floor(x / charWidth);
        
        // Metin satırlarını al
        const lines = this.value.split('\n');
        let targetPosition = 0;
        
        for (let i = 0; i < lineIndex && i < lines.length; i++) {
          targetPosition += lines[i].length + 1; // +1 for \n
        }
        
        if (lineIndex < lines.length) {
          const maxCharInLine = lines[lineIndex] ? lines[lineIndex].length : 0;
          targetPosition += Math.min(charInLine, maxCharInLine);
        }
        
        // Değişkeni hesaplanan pozisyona ekle
        const currentValue = this.value;
        const newValue = currentValue.substring(0, targetPosition) + variable + currentValue.substring(targetPosition);
        this.value = newValue;
        
        // Cursor'u eklenen değişkenin sonuna getir
        this.focus();
        this.setSelectionRange(targetPosition + variable.length, targetPosition + variable.length);
      } catch (error) {
        console.error('❌ Drop hatası:', error);
        // Fallback: cursor pozisyonuna ekle
        const currentValue = this.value;
        const cursorPos = this.selectionStart || 0;
        this.value = currentValue.substring(0, cursorPos) + variable + currentValue.substring(cursorPos);
        this.focus();
        this.setSelectionRange(cursorPos + variable.length, cursorPos + variable.length);
      }
    });
  }

  // Setup formatting toolbar for termin
  function setupTerminFormatting() {
    const formatButtons = document.querySelectorAll('.termin-format-btn');
    formatButtons.forEach(button => {
      button.addEventListener('click', function(e) {
        e.preventDefault();
        const format = this.getAttribute('data-format');
        formatTerminText(format);
      });
    });
  }
  
  // Termin Preview functionality
  function setupTerminPreview() {
    const previewBtn = document.getElementById('termin_preview_btn');
    const previewModal = document.getElementById('emailPreviewModal'); // Reuse email modal
    const previewContent = document.getElementById('emailPreviewContent');
    
    if (!previewBtn || !previewModal || !previewContent) return;
    
    previewBtn.addEventListener('click', function() {
      // Get current termin text
      let terminText = terminEditorEl.value.trim();
      
      if (!terminText) {
        terminText = 'Termin E-Mail-Inhalt ist leer...';
      }
      
      // Sample data for termin preview
      const sampleData = {
        '{% verbatim %}{{kunde_name}}{% endverbatim %}': 'Dogu Akagündüz',
        '{% verbatim %}{{termin_datum}}{% endverbatim %}': '24.09.2025 Mittwoch',
        '{% verbatim %}{{termin_uhrzeit}}{% endverbatim %}': '10:00 Uhr',
        '{% verbatim %}{{terminart}}{% endverbatim %}': 'Video',
        '{% verbatim %}{{berater_name}}{% endverbatim %}': 'Derya Coskun',
        '{% verbatim %}{{berater_position}}{% endverbatim %}': 'Vertriebsassistentin',
        '{% verbatim %}{{firma_name}}{% endverbatim %}': '{% if firma and firma.isim %}{{ firma.isim }}{% else %}Dogu Merkur{% endif %}',
        '{% verbatim %}{{firma_phone}}{% endverbatim %}': '{% if firma and firma.telefon %}{{ firma.telefon }}{% else %}+49 123 456 7890{% endif %}'
      };
      
      // Replace variables with sample data
      let previewText = terminText;
      for (const [variable, value] of Object.entries(sampleData)) {
        previewText = previewText.replace(new RegExp(variable.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), value);
      }
      
      // Convert newlines to <br> for HTML display
      previewText = previewText.replace(/\n/g, '<br>');
      
      // Update modal title
      const modalTitle = previewModal.querySelector('.modal-title');
      modalTitle.innerHTML = `<i class="ki-duotone ki-calendar fs-2 me-2"><span class="path1"></span><span class="path2"></span></i>Termin E-Mail Vorschau`;
      
      // Set preview content
      previewContent.innerHTML = previewText;
      
      // Show modal
      const modal = new bootstrap.Modal(previewModal);
      modal.show();
    });
  }

  // Color picker functionality for termin
  function showTerminColorPicker(selectedText, start, end) {
    const colorModal = document.getElementById('colorPickerModal'); // Reuse color modal
    const selectedTextPreview = document.getElementById('selectedTextPreview');
    const colorPreview = document.getElementById('colorPreview');
    const applyColorBtn = document.getElementById('applyColorBtn');
    const customColorInput = document.getElementById('customColorInput');
    const customColorText = document.getElementById('customColorText');
    
    if (!colorModal) return;
    
    // Set selected text preview
    selectedTextPreview.textContent = selectedText;
    colorPreview.textContent = selectedText;
    
    let selectedColor = '#0d6efd';
    
    // Color palette click handlers
    document.querySelectorAll('.color-option').forEach(option => {
      option.addEventListener('click', function() {
        // Remove previous selection
        document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
        // Add selection to clicked option
        this.classList.add('selected');
        
        selectedColor = this.getAttribute('data-color');
        colorPreview.style.color = selectedColor;
        customColorInput.value = selectedColor;
        customColorText.value = selectedColor;
      });
    });
    
    // Custom color input handlers
    customColorInput.addEventListener('input', function() {
      selectedColor = this.value;
      colorPreview.style.color = selectedColor;
      customColorText.value = selectedColor;
      // Remove palette selections
      document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
    });
    
    customColorText.addEventListener('input', function() {
      const color = this.value;
      if (/^#[0-9A-F]{6}$/i.test(color)) {
        selectedColor = color;
        colorPreview.style.color = selectedColor;
        customColorInput.value = selectedColor;
        // Remove palette selections
        document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
      }
    });
    
    // Apply color button
    applyColorBtn.onclick = function() {
      const formattedText = `<span style="color: ${selectedColor};">${selectedText}</span>`;
      
      // Replace selected text with formatted text in TERMIN editor
      const newValue = terminEditorEl.value.substring(0, start) + formattedText + terminEditorEl.value.substring(end);
      terminEditorEl.value = newValue;
      
      // Set cursor position after formatted text
      terminEditorEl.focus();
      terminEditorEl.setSelectionRange(start + formattedText.length, start + formattedText.length);
      
      // Close modal
      const modal = bootstrap.Modal.getInstance(colorModal);
      modal.hide();
    };
    
    // Show modal
    const modal = new bootstrap.Modal(colorModal);
    modal.show();
  }

  // Initialize termin functionality
  setupTerminDragAndDrop();
  setupTerminFormatting();
  setupTerminPreview();

  terminForm.addEventListener('submit', function(e){
    // Form submit - no special handling needed
  });
})();
</script>

{% if request.user.is_superuser or request.user.rol == 'Admin' %}
<!-- CKEditor 5 Classic (CDN) -->
<script src="https://cdn.ckeditor.com/ckeditor5/41.4.2/classic/ckeditor.js"></script>

<script>
/* =================== 1) Mevcut FOOTER CKEditor kodun (AYNEN) =================== */
(function(){
  const form = document.getElementById('footer_form');

  // Editor containerları
  const leftEl   = document.getElementById('footer_left_editor');
  const brLabel  = document.getElementById('btn_right_label_editor');
  const brModal  = document.getElementById('btn_right_modal_editor');
  const br2Label = document.getElementById('btn_right2_label_editor');
  const br2Modal = document.getElementById('btn_right2_modal_editor');

  let leftEditor, rightModalEditor, right2ModalEditor;

  const editorConfig = {
    language: 'de',
    toolbar: {
      items: [
        'undo','redo','|',
        'heading','|',
        'bold','italic','underline','link','|',
        'bulletedList','numberedList','outdent','indent','|',
        'blockQuote','insertTable','horizontalLine','removeFormat'
      ]
    },
    placeholder: 'Inhalt hier eingeben...',
    table: { contentToolbar: ['tableColumn','tableRow','mergeTableCells'] }
  };

  if (leftEl)  ClassicEditor.create(leftEl,  editorConfig).then(ed => leftEditor = ed);
  if (brModal) ClassicEditor.create(brModal, editorConfig).then(ed => rightModalEditor = ed);
  if (br2Modal)ClassicEditor.create(br2Modal,editorConfig).then(ed => right2ModalEditor = ed);

  if (form) {
    form.addEventListener('submit', function(e){
      if (!leftEditor || !rightModalEditor || !right2ModalEditor) {
        e.preventDefault();
        alert('Editor wird noch geladen. Bitte versuche es erneut.');
        return;
      }

      const leftVal   = leftEditor.getData().trim();
      const btnRLabel = (brLabel?.value || '').trim();
      const btnRModal = rightModalEditor.getData().trim();
      const btnR2Label= (br2Label?.value || '').trim();
      const btnR2Modal= right2ModalEditor.getData().trim();

      // En azından sol içerik veya ilk buton+modal dolu olsun
      if (!leftVal && !(btnRLabel && btnRModal)) {
        e.preventDefault();
        alert('Bitte gib mindestens den linken Inhalt oder den rechten Button mit Modal-Inhalt ein.');
        return;
      }

      document.getElementById('footer_left_input').value        = leftVal;
      document.getElementById('btn_right_label_input').value    = btnRLabel;
      document.getElementById('btn_right_modal_input').value    = btnRModal;
      document.getElementById('btn_right2_label_input').value   = btnR2Label;
      document.getElementById('btn_right2_modal_input').value   = btnR2Modal;
    });
  }
})();
</script>
{% endif %}
<script>
(function () {
  const list   = document.getElementById('sigorta_liste');
  const addBtn = document.getElementById('btn_sigorta_ekle');
  const form   = document.getElementById('sigorta_form');

  if (!list) return;


  // Her sigorta şirketi için ayrı event listener'lar oluştur
  function initializeItem(item) {
    const itemId = item.getAttribute('data-item-id');
    
    // Logo yükleme
    const fileInput = item.querySelector('.logo-file');
    if (fileInput) {
      fileInput.addEventListener('change', function(e) {
        const file = e.target.files?.[0];
        if (!file) return;
        
        const symbol = item.querySelector('.symbol');
        const oldImg = item.querySelector('.logo-preview');
        const placeholder = item.querySelector('.logo-placeholder');
        
        const url = URL.createObjectURL(file);
        
        if (placeholder) placeholder.remove();
        if (oldImg) {
          oldImg.src = url;
        } else {
          const img = document.createElement('img');
          img.className = 'rounded-2 logo-preview';
          img.alt = 'Logo';
          img.loading = 'lazy';
          img.style.cssText = 'width:100%; height:100%; object-fit:contain; background:#fff; padding:2px;';
          img.src = url;
          symbol.appendChild(img);
        }
        
        // Dosya seçilince "Bild entfernen" bayrağını sıfırla
        const delFlag = item.querySelector('.del-flag');
        if (delFlag) delFlag.value = '0';
      });
    }
    
    // Logo silme butonu
    const delImageBtn = item.querySelector('.del-image-btn');
    if (delImageBtn) {
      delImageBtn.addEventListener('click', function() {
        const companyName = item.querySelector('input[name="ss_isim[]"]').value || 'diese Gesellschaft';
        showDeleteConfirm(
          'Logo entfernen',
          `Sind Sie sicher, dass Sie das Logo von "${companyName}" entfernen möchten?`,
          function() {
            const delFlag = item.querySelector('.del-flag');
            const fileInput = item.querySelector('.logo-file');
            const img = item.querySelector('.logo-preview');
            const placeholder = item.querySelector('.logo-placeholder');
            
            if (delFlag) delFlag.value = '1';
            if (fileInput) fileInput.value = '';
            if (img) img.remove();
            if (!placeholder) {
              const symbol = item.querySelector('.symbol');
              const emp = document.createElement('div');
              emp.className = 'd-flex align-items-center justify-content-center w-100 h-100 rounded-2 bg-light text-muted small logo-placeholder';
              emp.textContent = 'Logo';
              symbol.appendChild(emp);
            }
          }
        );
      });
    }
    
    // Yukarı ok
    const upBtn = item.querySelector('.btn-up');
    if (upBtn) {
      upBtn.addEventListener('click', function() {
        const prev = item.previousElementSibling;
        if (prev && prev.classList.contains('sigorta-item')) {
          list.insertBefore(item, prev);
        }
      });
    }
    
    // Aşağı ok
    const downBtn = item.querySelector('.btn-down');
    if (downBtn) {
      downBtn.addEventListener('click', function() {
        const next = item.nextElementSibling;
        if (next && next.classList.contains('sigorta-item')) {
          list.insertBefore(next, item);
        }
      });
    }
    
    // Sil butonu
    const delBtn = item.querySelector('.btn_sigorta_sil');
    if (delBtn) {
      delBtn.addEventListener('click', function() {
        const companyName = item.querySelector('input[name="ss_isim[]"]').value || 'diese Gesellschaft';
        showDeleteConfirm(
          'Gesellschaft löschen',
          `Sind Sie sicher, dass Sie "${companyName}" löschen möchten?`,
          function() {
            const total = list.querySelectorAll('.sigorta-item').length;
            if (total <= 1) {
              // Son satır: sadece temizle
              item.querySelector('input[name="ss_id[]"]').value = '';
              item.querySelector('input[name="ss_isim[]"]').value = '';
              const fileInput = item.querySelector('input[name*="ss_resim_"]');
              if (fileInput) fileInput.value = '';
              const delFlag = item.querySelector('.del-flag');
              if (delFlag) delFlag.value = '0';
              item.querySelector('.logo-preview')?.remove();
              let placeholder = item.querySelector('.logo-placeholder');
              if (!placeholder) {
                const symbol = item.querySelector('.symbol');
                placeholder = document.createElement('div');
                placeholder.className = 'd-flex align-items-center justify-content-center w-100 h-100 rounded-2 bg-light text-muted small logo-placeholder';
                placeholder.textContent = 'Logo';
                symbol.appendChild(placeholder);
              }
            } else {
              item.remove();
            }
          }
        );
      });
    }
  }

  // Yeni satır oluştur
  function createNewRow(nameVal = '', idVal = '') {
    const timestamp = Date.now();
    const col = document.createElement('div');
    col.className = 'col-12 sigorta-item';
    col.setAttribute('data-item-id', `new_${timestamp}`);
    col.innerHTML = `
      <div class="item-wrap position-relative">
        <input type="hidden" name="ss_id[]" value="${idVal}">
        <input type="hidden" name="ss_resim_sil[]" value="0" class="del-flag">
        <input type="hidden" name="ss_key[]" value="new_${timestamp}" data-item-id="new_${timestamp}">

        <!-- Logo -->
        <div class="symbol me-4 flex-shrink-0">
          <div class="d-flex align-items-center justify-content-center w-100 h-100 rounded-2 bg-light text-muted small logo-placeholder">
            Logo
          </div>
        </div>

        <!-- İsim ve Kapsam -->
        <div class="name-col me-3">
          <input type="text" name="ss_isim[]" class="form-control mb-2" required maxlength="255" placeholder="Name der Versicherungsgesellschaft" value="${nameVal}">
          <select name="ss_kapsam[]" class="form-select form-select-sm">
            <option value="Privat">Privat</option>
            <option value="Gesetzlich">Gesetzlich</option>
            <option value="Beides" selected>Beides</option>
          </select>
        </div>

        <!-- Dosya + Sil checkbox + Oklar/Sil -->
        <div class="ctrl-col">
          <div class="file-block">
            <input type="file" name="ss_resim_new_${timestamp}" accept="image/*" class="form-control form-control-sm logo-file" data-item-id="new_${timestamp}">
          </div>
          <button type="button" class="btn btn-outline-danger btn-sm del-image-btn" data-item-id="new_${timestamp}" title="Logo entfernen">
            <i class="fa-solid fa-image me-1"></i>Logo entfernen
          </button>

          <div class="actions">
            <button type="button" class="btn btn-light btn-sm btn-up" title="Nach oben" data-item-id="new_${timestamp}">
              <i class="fa-solid fa-arrow-up"></i>
            </button>
            <button type="button" class="btn btn-light btn-sm btn-down" title="Nach unten" data-item-id="new_${timestamp}">
              <i class="fa-solid fa-arrow-down"></i>
            </button>
            <button type="button" class="btn btn-light-danger btn-sm btn_sigorta_sil" title="Löschen" data-item-id="new_${timestamp}">
              <i class="fa-solid fa-trash"></i>
            </button>
          </div>
        </div>
      </div>`;
    
    list.appendChild(col);
    initializeItem(col);
  }

  // Mevcut tüm item'ları initialize et
  list.querySelectorAll('.sigorta-item').forEach(initializeItem);


  // Yeni satır ekle butonu
  addBtn?.addEventListener('click', () => createNewRow());

  // Submit validasyonu
  form?.addEventListener('submit', (e) => {
    const inputs = Array.from(form.querySelectorAll('input[name="ss_isim[]"]'));
    const names  = inputs.map(i => (i.value || '').trim()).filter(Boolean);

    if (names.length !== inputs.length) {
      e.preventDefault();
      alert('Bitte fülle alle Gesellschaftsnamen aus.');
      return;
    }
    const lower = names.map(n => n.toLowerCase());
    const hasDup = lower.some((n, i) => lower.indexOf(n) !== i);
    if (hasDup) {
      e.preventDefault();
      alert('Doppelte Namen sind nicht erlaubt.');
      return;
    }
  });
})();
</script>
<script>
(function () {
  const asModalEl   = document.getElementById('modal_alt_sirket');
  if (!asModalEl) return;

  const asModal     = new bootstrap.Modal(asModalEl);
  const asTitle     = document.getElementById('as_modal_title');
  const asForm      = document.getElementById('as_form');
  const asListe     = document.getElementById('as_liste');
  const asSirketId  = document.getElementById('as_sirket_id');
  const asBtnEkle   = document.getElementById('as_btn_ekle');
  const asErr       = document.getElementById('as_error');
  const asOk        = document.getElementById('as_success');

  function asHideMsgs() {
    asErr.classList.add('d-none');
    asOk.classList.add('d-none');
    asErr.textContent = '';
    asOk.textContent  = '';
  }

  function asRelabel() {
    // DOM-Reihenfolge → Backend sira = 1..N (bereits in View umgesetzt)
  }

  function asMoveUp(item) {
    const prev = item.previousElementSibling;
    if (prev && prev.classList.contains('as-item')) {
      asListe.insertBefore(item, prev);
      asRelabel();
    }
  }

  function asMoveDown(item) {
    const next = item.nextElementSibling;
    if (next && next.classList.contains('as-item')) {
      asListe.insertBefore(next, item); // swap
      asRelabel();
    }
  }

  function asNewRow(nameVal = '', idVal = '') {
    const col = document.createElement('div');
    col.className = 'col-12 as-item';
    col.innerHTML = `
      <div class="d-flex align-items-center rounded border p-3 bg-light position-relative">
        <input type="hidden" name="as_id[]" value="${idVal}">
        <div class="flex-grow-1 me-3">
          <input type="text" name="as_isim[]" class="form-control" maxlength="255"
                 placeholder="Name der Untergesellschaft" value="${nameVal}">
        </div>
        <div class="d-flex align-items-center gap-2">
          <button type="button" class="btn btn-light btn-sm as-up" title="Nach oben">
            <i class="fa-solid fa-arrow-up"></i>
          </button>
          <button type="button" class="btn btn-light btn-sm as-down" title="Nach unten">
            <i class="fa-solid fa-arrow-down"></i>
          </button>
          <button type="button" class="btn btn-light-danger btn-sm as-del" title="Löschen">
            <i class="fa-solid fa-trash"></i>
          </button>
        </div>
      </div>`;
    asListe.appendChild(col);
    asRelabel();
  }

  // Delegation: Pfeile & Löschen
  asListe.addEventListener('click', (e) => {
    const item = e.target.closest('.as-item');
    if (!item) return;

    if (e.target.closest('.as-up'))   return asMoveUp(item);
    if (e.target.closest('.as-down')) return asMoveDown(item);
    if (e.target.closest('.as-del'))  {
      item.remove(); // letzte Zeile darf jetzt auch entfernt werden (Liste kann leer sein)
      asRelabel();
    }
  });

  // Neue Untergesellschaft
  asBtnEkle?.addEventListener('click', () => asNewRow());

  // Öffnen: Button in der Gesellschaftszeile
  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('.btn-alt');
    if (!btn) return;

    asHideMsgs();

    const sid  = btn.getAttribute('data-sirket-id');
    const name = btn.getAttribute('data-sirket-isim') || 'Gesellschaft';

    asSirketId.value = sid;
    asTitle.textContent = name;

    asListe.innerHTML = `<div class="col-12"><div class="text-muted">Wird geladen…</div></div>`;

    try {
      const url = `{% url 'sigorta_alt_list' %}?sirket_id=${encodeURIComponent(sid)}`;
      const resp = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
      if (!resp.ok) throw new Error();
      const data = await resp.json();

      asListe.innerHTML = '';
      if (data.ok && Array.isArray(data.items) && data.items.length) {
        data.items.forEach(it => asNewRow(it.isim, it.id));
      } else {
        // Keine Untergesellschaft vorhanden → leere Liste anzeigen (Nutzer kann hinzufügen)
        asListe.innerHTML = '';
      }
      asModal.show();
    } catch (err) {
      asListe.innerHTML = '';
      asErr.textContent = 'Beim Laden der Untergesellschaften ist ein Fehler aufgetreten.';
      asErr.classList.remove('d-none');
      asModal.show();
    }
  });

  // Speichern
  asForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    asHideMsgs();

    const inputs = Array.from(asForm.querySelectorAll('input[name="as_isim[]"]'));
    const names  = inputs.map(i => (i.value || '').trim()).filter(Boolean);

    // Nur in nicht-leeren Namen Duplikate verbieten
    const lower = names.map(n => n.toLowerCase());
    const hasDup = lower.some((n, i) => lower.indexOf(n) !== i);
    if (hasDup) {
      asErr.textContent = 'Doppelte Namen sind nicht erlaubt.';
      asErr.classList.remove('d-none');
      return;
    }

    // Leere Liste absenden = alles löschen (Server-seitig umgesetzt)
    const fd = new FormData(asForm);
    try {
      const resp = await fetch(`{% url 'sigorta_alt_save' %}`, {
        method: 'POST',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        body: fd
      });
      const data = await resp.json();
      if (!resp.ok || !data.ok) {
        asErr.textContent = (data && data.msg) ? data.msg : 'Beim Speichern ist ein Fehler aufgetreten.';
        asErr.classList.remove('d-none');
        return;
      }
      asOk.textContent = data.msg || 'Erfolgreich gespeichert.';
      asOk.classList.remove('d-none');
    } catch (err) {
      asErr.textContent = 'Beim Speichern ist ein Fehler aufgetreten.';
      asErr.classList.remove('d-none');
    }
  });
})();
</script>


{% endblock %}